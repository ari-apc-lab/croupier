tosca_definitions_version: cloudify_dsl_1_3

#Importing data management infrastructures
imports:
  - cesga_data_management.cfy.yaml
  - sodalite_data_management.cfy.yaml
  - cloud_data_management.cfy.yaml

#CESGA HPC
# TODO InfrastructureInterface (for SSH HPC connection supporting Job deployment) should be managed similarly to DataAccessInterface
# InfrastructureInterface and DataAccessInterface could be subclasses of a ComputingInterface that shores common properties.
cesga_hpc:
  type: croupier.nodes.InfrastructureInterface
  properties:
    config: { get_input: cesga_hpc_interface_config }
    credentials: { get_input: cesga_hpc_interface_credentials }

#SODALITE HPC
sodalite_hpc:
  type: croupier.nodes.InfrastructureInterface
  properties:
    config: { get_input: sodalite_hpc_interface_config }
    credentials: { get_input: sodalite_hpc_interface_credentials }

#WORKFLOW

#INPUTS
in1:
  type: croupier.nodes.FileDataSource
  properties:
    filepath: /path/to/in1
  relationships:
    - type: located_at
      target: cesga_data_access_infra

in2:
  type: croupier.nodes.WebDataSource
  properties:
    resource: /query1/
  relationships:
    - type: located_at
      target: cloud_data_access_infra

in3:
  type: croupier.nodes.WebDataSource
  properties:
    resource: /query2/
  relationships:
    - type: located_at
      target: cloud_data_access_infra

in4:
  type: croupier.nodes.FileDataSource
  properties:
    filepath: /path/to/in4
  relationships:
    - type: located_at
      target: sodalite_data_access_infra

#OUTPUTS
out1:
  type: croupier.nodes.FileDataSource
  properties:
    filepath: /path/to/out1
  relationships:
    - type: located_at
      target: cesga_data_access_infra

out2:
  type: croupier.nodes.FileDataSource
  properties:
    filepath: /path/to/out2
  relationships:
    - type: located_at
      target: cesga_data_access_infra

#JOBS
# TODO JOB node needs to be extended to support the specification of its inputs and outputs
job1:
  type: croupier.nodes.Job
  relationships:
    - type: job_managed_by_interface
      target: cesga_hpc
    - type: job_inputs
      target:
        - in1
        - in2
    - type: job_outputs
      target:
        - out1

job2:
  type: croupier.nodes.Job
  relationships:
    - type: job_managed_by_interface
      target: sodalite_hpc
    - type: job_inputs
      target:
        - in3
        - in4
    - type: job_outputs
      target:
        - out2

# DATA TRANSFER
dt1:
  type: croupier.nodes.DataTransfer
  properties:
    transfer_protocol: RSync
  relationships:
    - type: from_source
      target: out1
    - type: to_target
      target: in4